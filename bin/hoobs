#!/usr/bin/env node

process.title = "hoobs";

const File = require("fs-extra");

const { dirname, join } = require("path");
const { execSync } = require("child_process");

let password = null;
let debug = false;

const command = process.argv[2];

process.argv.forEach((value, index) => {
    if (value === "-p") {
        password = "#sudo-password#"
    } else if (password === "#sudo-password#") {
        password = value;

        return;
    } else if (value === "-D" || value === "--debug") {
        debug = true;
    }
});

switch ((command || "").toLowerCase()) {
    case "instance":
        const root = dirname(File.realpathSync(__filename));

        switch ((process.argv[3] || "").toLowerCase()) {
            case "client":
                (require(join(root, "../scripts/client")))();
                break;

            case "create":
                (require(join(root, "../scripts/instance")))();
                break;
        }

        break;

    case "service":
        switch ((process.argv[3] || "").toLowerCase()) {
            case "log":
                execSync("journalctl -o cat -n 500 -f -u hoobs", {
                    stdio: "inherit"
                });

                break;

            case "install":
                (async () => {
                    const root = dirname(File.realpathSync(__filename));
                    const enviornment = await (require(join(root, "../scripts/enviornment")))();
                
                    await (require(join(root, "../scripts/migrate")))(enviornment);
                    await (require(join(root, "../scripts/prerequisites")))();
                    await (require(join(root, "../scripts/nginx")))(true);
                    await (require(join(root, "../scripts/systemd")))(true);
                    await (require(join(root, "../scripts/reboot")))(true, "hoobs.service");
                })();

                break;

            case "start":
                if (File.existsSync("/etc/systemd/system/hoobs.service")) {
                    execSync("systemctl start hoobs.service");
                }

                break;

            case "stop":
                if (File.existsSync("/etc/systemd/system/hoobs.service")) {
                    execSync("systemctl stop hoobs.service");
                }

                break;

            case "restart":
                if (File.existsSync("/etc/systemd/system/hoobs.service")) {
                    execSync("systemctl restart hoobs.service");
                }

                break;

            case "enable":
                if (File.existsSync("/etc/systemd/system/hoobs.service")) {
                    execSync("systemctl enable hoobs.service");
                }

                break;
    
            case "disable":
                if (File.existsSync("/etc/systemd/system/hoobs.service")) {
                    execSync("systemctl disable hoobs.service");
                }

                break;
        }

        break;

    case "upgrade":
        (async () => {
            const root = dirname(File.realpathSync(__filename));

            let configured = false;

            if (File.existsSync("/home")) {
                const folders = File.readdirSync("/home").filter(file => File.lstatSync(join("/home", file)).isDirectory());
    
                for (let i = 0; i < folders.length; i++) {    
                    if (File.existsSync(join("/home", folders[i], ".hoobs/etc/config.json"))) {
                        configured = true;
                    }
                }
            }
    
            if (File.existsSync("/root/.hoobs/etc/config.json")) {    
                configured = true;
            }

            if (configured) {
                await (require(join(root, "../scripts/nginx")))(false);
                await (require(join(root, "../scripts/systemd")))(false);
                await (require(join(root, "../scripts/config")))();
                await (require(join(root, "../scripts/reboot")))(false, "hoobs.service");
            }
        })();

        break;

    case "cockpit":
        new (require(join(dirname(File.realpathSync(__filename)), "../lib/cockpit")))().start(true).then((registration) => {
            console.log("registration code");
            console.log(registration);
        }).catch((error) => {
            console.log(error);
        });

        break;

    case "switch":
        (async () => {
            const root = dirname(File.realpathSync(__filename));

            switch ((process.argv[3] || "").toLowerCase()) {
                case "hoobs":
                    if (File.existsSync("/etc/systemd/system/hoobs.service") && File.existsSync("/etc/systemd/system/homebridge.service")) {
                        execSync("systemctl stop homebridge.service");
                        execSync("systemctl disable homebridge.service");
                    }

                    if (File.existsSync("/etc/systemd/system/homebridge-config-ui-x.service")) {
                        execSync("systemctl stop homebridge-config-ui-x.service");
                        execSync("systemctl disable homebridge-config-ui-x.service");
                    }

                    if (File.existsSync("/etc/systemd/system/hoobs.service") && File.existsSync("/etc/systemd/system/homebridge.service")) {
                        execSync("systemctl enable hoobs.service");
                        execSync("systemctl restart hoobs.service");
                    }

                    break;
                
                case "homebridge":
                    if (File.existsSync("/etc/systemd/system/hoobs.service") && File.existsSync("/etc/systemd/system/homebridge.service")) {
                        execSync("systemctl stop hoobs.service");
                        execSync("systemctl disable hoobs.service");
                    }

                    if (File.existsSync("/etc/systemd/system/hoobs.service") && File.existsSync("/etc/systemd/system/homebridge.service")) {
                        execSync("systemctl enable homebridge.service");
                        execSync("systemctl restart homebridge.service");
                    }

                    if (File.existsSync("/etc/systemd/system/homebridge-config-ui-x.service")) {
                        execSync("systemctl enable homebridge-config-ui-x.service");
                        execSync("systemctl restart homebridge-config-ui-x.service");
                    }

                    break;
                
                case "uninstall":
                    await (require(join(root, "../scripts/uninstall")))((await (require(join(root, "../scripts/enviornment")))()));
                    break;
            }
        })();

        break;

    default:
        (require(join(dirname(File.realpathSync(__filename)), "../scripts/loader")))(debug, password);

        break;
}
