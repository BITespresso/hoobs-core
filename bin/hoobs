#!/usr/bin/env node

process.title = "hoobs-core";

const OS = require("os");
const Ora = require("../node_modules/ora");
const File = require("../node_modules/fs-extra/lib");
const Remove = require("../node_modules/rimraf");

const { dirname, join } = require("path");
const { exec, spawn } = require("child_process");

let password = null;

process.argv.forEach((value, index) => {
    if (value === "-p") {
        password = "#sudo-password#"
    } else if (password === "#sudo-password#") {
        password = value;

        return;
    }
});

const home = OS.userInfo().homedir;
const root = join(home, ".hoobs");
const applicaiton = join(dirname(File.realpathSync(__filename)), "../");
const installed = JSON.parse(File.readFileSync(join(applicaiton, "package.json")));

let executing = null;
let throbber = null;

if (!File.existsSync(root)){
    File.mkdirSync(root);
}

if (File.existsSync(join(root, "package.json"))) {
    try {
        executing = JSON.parse(File.readFileSync(join(root, "package.json")));
    } catch {
        executing = null;
    }
}

const preparePackage = function() {
    const plugins = [];

    throbber = Ora("Initilizing").start();

    if (executing && executing.dependencies) {
        const dependencies = Object.keys(executing.dependencies);

        for (let i = 0; i < dependencies.length; i++) {
            const name = dependencies[i];
            const dependency = executing.dependencies[dependencies[i]];

            if ((name.startsWith("homebridge-") || (name.startsWith("@hoobs/") && name !== "@hoobs/homebridge")) && !installed.dependencies.hasOwnProperty(name)) {
                installed.dependencies[name] = dependency;

                plugins.push(name);
            }
        }
    }

    if (installed.devDependencies) {
        delete installed.devDependencies;
    }

    if (installed.scripts) {
        delete installed.scripts;
    }

    if (installed.bin) {
        delete installed.bin;
    }

    if (File.existsSync(join(root, "package.json"))) {
        File.unlinkSync(join(root, "package.json"));
    }

    File.appendFileSync(join(root, "package.json"), JSON.stringify(installed, null, 4));

    throbber.stop();

    return plugins;
}

const setupUserMode = function() {
    throbber = Ora("Setting Up User Mode").start();

    if (File.existsSync(join(root, "dist"))) {
        Remove.sync(join(root, "dist"));
    }

    if (File.existsSync(join(root, "lib"))) {
        Remove.sync(join(root, "lib"));
    }

    if (File.existsSync(join(root, "node_modules"))) {
        Remove.sync(join(root, "node_modules"));
    }

    File.copySync(join(applicaiton, "node_modules"), join(root, "node_modules"));

    if (File.existsSync(join(root, "package-lock.json"))) {
        File.unlinkSync(join(root, "package-lock.json"));
    }

    if (File.existsSync(join(root, "default.json"))) {
        File.unlinkSync(join(root, "default.json"));
    }

    File.copySync(join(applicaiton, "default.json"), join(root, "default.json"));

    throbber.stop();
}

const installPackages = function(plugins) {
    return new Promise((resolve) => {
        throbber = Ora("Initilizing Plugins").start();

        if (plugins.length > 0) {
            exec(`npm set progress=false && npm install --unsafe-perm ${plugins.join(" ")}`, {
                cwd: root
            }, () => {
                throbber.stop();
        
                resolve();
            });
        } else {
            throbber.stop();

            resolve();
        }
    });
}

if (!executing || installed.version !== executing.version || !File.existsSync(join(root, "lib")) || !File.existsSync(join(root, "dist"))) {
    const plugins = preparePackage();

    setupUserMode();

    installPackages(plugins).then(() => {
        File.copySync(join(applicaiton, "dist"), join(root, "dist"));
        File.copySync(join(applicaiton, "lib"), join(root, "lib"));

        require(join(root, "lib/cli"))();
    });
} else {
    require(join(root, "lib/cli"))();
}
